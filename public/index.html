<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manual Actuator</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="project.ico" type="image/x-icon">
</head>
<body>
<div id="table">
    <h1>List of Manual Actuators</h1>
    <button onclick="addRow()">➕ Add Row</button>
    <button onclick="removeRow()">➖ Remove Last Row</button>
    <table class="dataframe" style="width:90%" id="editableTable">
        <thead>
            <tr style="text-align: center;">
                <th>NAME</th>
                <th>DESCRIPTION</th>
                <th>BARCODE</th>
                <th>REMARKS</th>
            </tr>
        </thead>
        <tbody>
            <!-- Table rows will be generated by JS -->
        </tbody>
    </table>
</div>
<div id="output"></div>
<script>
    let nextIndex = 0;

    function updateNextIndex() {
        const cells = document.querySelectorAll("#editableTable td[data-index]");
        let maxFound = -1;
        cells.forEach(cell => {
            const idx = parseInt(cell.getAttribute('data-index'));
            if (idx > maxFound) maxFound = idx;
        });
        nextIndex = maxFound + 1;
    }

    function loadData() {
        fetch('/api/data')
            .then(res => res.json())
            .then(data => {
                const table = document.getElementById("editableTable");
                const tbody = table.querySelector('tbody');
                tbody.innerHTML = ""; // Clear all rows

                // Find the highest cell index
                let maxIndex = -1;
                Object.keys(data).forEach(key => {
                    const idx = parseInt(key.replace('cell', ''));
                    if (idx > maxIndex) maxIndex = idx;
                });

                // Rebuild rows based on data
                const columns = table.querySelectorAll('thead th').length;
                const rowCount = Math.ceil((maxIndex + 1) / columns);

                for (let r = 0; r < rowCount; r++) {
                    const tr = document.createElement('tr');
                    for (let c = 0; c < columns; c++) {
                        const cellIndex = r * columns + c;
                        const td = document.createElement('td');
                        td.setAttribute('data-index', cellIndex);
                        td.innerText = data[`cell${cellIndex}`] || "";
                        td.ondblclick = () => editCell(td);
                        tr.appendChild(td);
                    }
                    tbody.appendChild(tr);
                }

                nextIndex = (rowCount * columns);
            })
            .catch(err => console.error('Error loading data:', err));
    }

    function saveData() {
        document.querySelectorAll("#editableTable td[data-index]").forEach(cell => {
            const index = cell.getAttribute('data-index');
            const value = cell.innerText;
            fetch('/api/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ index, value })
            });
        });
    }

    function editCell(td) {
        const currentText = td.innerText;
        const input = document.createElement("input");
        input.type = "text";
        input.value = currentText;
        td.innerHTML = "";
        td.appendChild(input);
        input.focus();

        input.addEventListener("blur", () => saveEdit(td, input.value));
        input.addEventListener("keydown", e => { if (e.key === "Enter") input.blur(); });
    }

    function saveEdit(td, newValue) {
        const index = td.getAttribute('data-index');
        td.innerText = newValue;
        fetch('/api/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ index, value: newValue })
        }).then(res => res.json())
          .then(r => console.log(r.message));
    }

    function makeAllCellsEditable() {
        document.querySelectorAll('#editableTable td[data-index]').forEach(cell => {
            cell.ondblclick = () => editCell(cell);
        });
    }

    function addRow() {
        const table = document.getElementById("editableTable");
        const columnCount = table.querySelectorAll('thead th').length;
        const tbody = table.querySelector('tbody');
        const newRow = tbody.insertRow(-1);
        let firstCell = null;

        for (let i = 0; i < columnCount; i++) {
            const newCell = newRow.insertCell(i);
            newCell.setAttribute("data-index", nextIndex++);
            newCell.ondblclick = () => editCell(newCell);
            newCell.innerText = "";

            fetch('/api/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ index: newCell.getAttribute('data-index'), value: "" })
            });

            if (i === 0) firstCell = newCell;
        }

        if (firstCell) editCell(firstCell);
    }

    function removeRow() {
        const table = document.getElementById("editableTable");
        const tbody = table.tBodies[0];
        if (tbody.rows.length > 0) {
            tbody.deleteRow(-1);
        } else {
            alert("No more rows to remove.");
        }
    }

    window.onload = function () {
        updateNextIndex();
        loadData();
        makeAllCellsEditable();
    };
</script>
</body>
</html>